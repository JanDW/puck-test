<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset="UTF-8">
  <title>Puck test</title>
</head>
<body>
  <button type="button" id="ble-button">Enable bluetooth</button>
  <script src="https://www.puck-js.com/puck.js"></script>
  <script type="text/javascript">
    var bleButton = document.getElementById('ble-button')
    // Called when we get a line of data - updates the light color
    function onLine(v) {
      console.log("Received: "+JSON.stringify(v));
    }

    // When clicked, connect or disconnect
    var connection;
    bleButton.addEventListener('click', function() {
      if (connection) {
        connection.close();
        connection = undefined;
      }
      Puck.connect(function(c) {
        if (!c) {
          alert('Couldn\'t connect!');
          return;
        }
        connection = c;
        // Handle the data we get back, and call 'onLine'
        // whenever we get a line
        var buf = '';
        connection.on('data', function(d) {
          buf += d;
          var i = buf.indexOf('\n');
          while (i>=0) {
            onLine(buf.substr(0,i));
            buf = buf.substr(i+1);
            i = buf.indexOf('\n');
          }
        });

      function sendToggle() {console.log('button pressed');return true;};
        // First, reset Puck.js
        connection.write('reset();\n', function() {
          // Wait for it to reset itself
          connection.write('setWatch(sendToggle, BTN, { edge:"rising", debounce:50, repeat: true })');
        });
      });
    });
  </script>
</body>
</html>
